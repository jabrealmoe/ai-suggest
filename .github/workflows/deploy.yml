name: Deploy to Forge

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Forge environment to deploy to"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install Forge CLI
        run: npm install -g @forge/cli

      - name: Check for FORGE_API_TOKEN
        run: |
          if [ -z "${{ secrets.FORGE_API_TOKEN }}" ]; then
            echo "⚠ Error: FORGE_API_TOKEN secret is not configured"
            echo ""
            echo "To enable automated deployment:"
            echo "1. Create a Forge API token: https://developer.atlassian.com/console/myapps/"
            echo "2. Add it as a GitHub secret named FORGE_API_TOKEN"
            echo "3. Repository Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          echo "✓ FORGE_API_TOKEN is configured"

      - name: Authenticate with Forge
        env:
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}
        run: |
          # Forge CLI uses environment variable for authentication
          # The token should be set as a GitHub secret
          echo "Authenticating with Forge..."
          forge whoami || echo "Note: Authentication will happen during deploy"

      - name: Lint Forge app
        run: |
          forge settings set usage-analytics false
          forge lint

      - name: Deploy to Forge
        env:
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}
        run: |
          ENV="${{ github.event.inputs.environment }}"

          if [ -z "$ENV" ]; then
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              ENV="production"
            else
              ENV="development"
            fi
          fi

          echo "Deploying to $ENV environment..."
          forge deploy --non-interactive -e $ENV

      - name: Deployment summary
        if: success()
        run: |
          echo "✓ Deployment successful"
          echo "Environment: ${{ github.event.inputs.environment || 'development' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
