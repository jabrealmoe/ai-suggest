name: Deploy to Forge

on:
  # Deploy to Staging on push to main
  push:
    branches:
      - main
      - develop
    tags:
      - "v*"

  # Allow manual deployment to any environment
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Environment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Tests (Unit & Backend)
        run: |
          npm test
          npm run test:backend

      - name: Build project
        run: npm run build

      - name: Install Forge CLI
        run: npm install -g @forge/cli

      - name: Determine Target Environment
        id: target-env
        run: |
          TARGET_ENV="development"

          # 1. Manual Trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            
          # 2. Tag -> Production
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TARGET_ENV="production"
            
          # 3. Main -> Staging
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            TARGET_ENV="staging"
            
          # 4. Develop -> Development
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            TARGET_ENV="development"
          fi

          echo "Selected Environment: $TARGET_ENV"
          echo "env=$TARGET_ENV" >> $GITHUB_OUTPUT

      - name: Authenticate with Forge
        env:
          FORGE_EMAIL: ${{ secrets.FORGE_EMAIL }}
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}
        run: |
          if [ -z "$FORGE_EMAIL" ] || [ -z "$FORGE_API_TOKEN" ]; then
            echo "::error::Secrets FORGE_EMAIL and FORGE_API_TOKEN are required."
            exit 1
          fi
          # Disable analytics to prevent prompt
          forge settings set usage-analytics false
          echo "Authenticating..."
          # Login not strictly needed if env vars are set, but good for verification if needed
          # Forge CLI reads env vars automatically for commands

      - name: Deploy to ${{ steps.target-env.outputs.env }}
        env:
          FORGE_EMAIL: ${{ secrets.FORGE_EMAIL }}
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}
        run: |
          ENVIRONMENT="${{ steps.target-env.outputs.env }}"
          echo "ðŸš€ Deploying to $ENVIRONMENT..."

          forge deploy --verbose --non-interactive -e $ENVIRONMENT

      - name: Verify Deployment
        if: success()
        run: echo "âœ… Successfully deployed to ${{ steps.target-env.outputs.env }}"
